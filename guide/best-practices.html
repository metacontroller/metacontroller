<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Constraints and best practices - Metacontroller</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Lightweight Kubernetes controllers as a service">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../examples.html"><strong aria-hidden="true">1.2.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../concepts.html"><strong aria-hidden="true">1.3.</strong> Concepts</a></li><li class="chapter-item expanded "><a href="../features.html"><strong aria-hidden="true">1.4.</strong> Features</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">1.5.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="../pronunciation.html"><strong aria-hidden="true">1.6.</strong> Pronunciation</a></li></ol></li><li class="chapter-item expanded "><a href="../guide.html"><strong aria-hidden="true">2.</strong> User Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guide/install.html"><strong aria-hidden="true">2.1.</strong> Install Metacontroller</a></li><li class="chapter-item expanded "><a href="../guide/helm-install.html"><strong aria-hidden="true">2.2.</strong> Install Metacontroller via helm</a></li><li class="chapter-item expanded "><a href="../guide/configuration.html"><strong aria-hidden="true">2.3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../guide/create.html"><strong aria-hidden="true">2.4.</strong> Create a controller</a></li><li class="chapter-item expanded "><a href="../guide/best-practices.html" class="active"><strong aria-hidden="true">2.5.</strong> Constraints and best practices</a></li><li class="chapter-item expanded "><a href="../guide/troubleshooting.html"><strong aria-hidden="true">2.6.</strong> Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><a href="../api.html"><strong aria-hidden="true">3.</strong> API Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../api/apply.html"><strong aria-hidden="true">3.1.</strong> Apply Semantics</a></li><li class="chapter-item expanded "><a href="../api/compositecontroller.html"><strong aria-hidden="true">3.2.</strong> CompositeController</a></li><li class="chapter-item expanded "><a href="../api/controllerrevision.html"><strong aria-hidden="true">3.3.</strong> ControllerRevision</a></li><li class="chapter-item expanded "><a href="../api/decoratorcontroller.html"><strong aria-hidden="true">3.4.</strong> DecoratorController</a></li><li class="chapter-item expanded "><a href="../api/customize.html"><strong aria-hidden="true">3.5.</strong> Customize Hook</a></li><li class="chapter-item expanded "><a href="../api/hook.html"><strong aria-hidden="true">3.6.</strong> Hook</a></li></ol></li><li class="chapter-item expanded "><a href="../design.html"><strong aria-hidden="true">4.</strong> Design Docs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/map-controller.html"><strong aria-hidden="true">4.1.</strong> MapController</a></li></ol></li><li class="chapter-item expanded "><a href="../contrib.html"><strong aria-hidden="true">5.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contrib/build.html"><strong aria-hidden="true">5.1.</strong> Building</a></li><li class="chapter-item expanded "><a href="../contrib/debug.html"><strong aria-hidden="true">5.2.</strong> Local development/debug</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Metacontroller</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/metacontroller/metacontroller" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="constraints-and-best-practices"><a class="header" href="#constraints-and-best-practices">Constraints and best practices</a></h1>
<p>This is a collection of recommendations for writing controllers with Metacontroller.</p>
<p>If you have something to add to the collection, please send a pull request against
<a href="https://www.github.com/metacontroller/metacontroller/tree/master/docs/src/guide/best-practices.md">this document</a>.</p>
<ul>
<li><a href="#constraints">Constraints</a>
<ul>
<li><a href="#objects-relationship">Objects relationship</a></li>
</ul>
</li>
<li><a href="#lambda-hooks">Lambda Hooks</a>
<ul>
<li><a href="#apply-semantics">Apply Semantics</a></li>
<li><a href="#side-effects">Side Effects</a></li>
<li><a href="#status">Status</a>
<ul>
<li><a href="#working-with-status-subresource-in-metacontroller">Working with Status subresource in metacontroller</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="constraints"><a class="header" href="#constraints">Constraints</a></h2>
<h3 id="objects-relationship"><a class="header" href="#objects-relationship">Objects relationship</a></h3>
<p>Because of limitations of Kubernetes <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/garbage-collection.md#api-changes">garbage collection</a>
we have following restrictions between objects:</p>
<table><thead><tr><th>Parent</th><th>Child</th><th>Related</th></tr></thead><tbody>
<tr><td>Cluster</td><td>- Cluster <br> - Namespaced (any namespace)</td><td>- Cluster <br> - Namespaced (any namespace)</td></tr>
<tr><td>Namespaced</td><td>- Namespaced (the same namespace as parent)</td><td>-  Namespaced (the same namespace as parent)</td></tr>
</tbody></table>
<h2 id="lambda-hooks"><a class="header" href="#lambda-hooks">Lambda Hooks</a></h2>
<h3 id="apply-semantics"><a class="header" href="#apply-semantics">Apply Semantics</a></h3>
<p>Because Metacontroller uses <a href="../api/apply.html">apply semantics</a>, you don't have to
think about whether a given object needs to be created (because it doesn't exist)
or patched (because it exists and some fields don't match your desired state).
In either case, you should generate a fresh object from scratch with only the
fields you care about filled in.</p>
<p>For example, suppose you create an object like this:</p>
<pre><code class="language-yaml">apiVersion: example.com/v1
kind: Foo
metadata:
  name: my-foo
spec:
  importantField: 1
</code></pre>
<p>Then later you decide to change the value of <code>importantField</code> to 2.</p>
<p>Since Kubernetes API objects can be edited by the API server, users, and other
controllers to collaboratively produce emergent behavior, the object you observe
might now look like this:</p>
<pre><code class="language-yaml">apiVersion: example.com/v1
kind: Foo
metadata:
  name: my-foo
  stuffFilledByAPIServer: blah
spec:
  importantField: 1
  otherField: 5
</code></pre>
<p>To avoid overwriting the parts of the object you don't care about, you would
ordinarily need to either build a patch or use a retry loop to send
concurrency-safe updates.
With apply semantics, you instead just call your &quot;generate object&quot; function
again with the new values you want, and return this (as JSON):</p>
<pre><code class="language-yaml">apiVersion: example.com/v1
kind: Foo
metadata:
  name: my-foo
spec:
  importantField: 2
</code></pre>
<p>Metacontroller will take care of merging your change to <code>importantField</code> while
preserving the fields you don't care about that were set by others.</p>
<h3 id="side-effects"><a class="header" href="#side-effects">Side Effects</a></h3>
<p>Your hook code should generally be free of side effects whenever possible.
Ideally, you should interpret a call to your hook as asking,
&quot;Hypothetically, if the observed state of the world were like this, what would
your desired state be?&quot;</p>
<p>In particular, Metacontroller may ask you about such hypothetical scenarios
during rolling updates, when your object is undergoing a slow transition between
two desired states.
If your hook has to produce side effects to work, you should avoid enabling
rolling updates on that controller.</p>
<h3 id="status"><a class="header" href="#status">Status</a></h3>
<p>If your object uses the Spec/Status convention, keep in mind that the Status
returned from your hook should ideally reflect a judgement on only the observed
objects that were sent to you.
The Status you compute should not yet account for your desired state, because
the actual state of the world may not match what you want yet.</p>
<p>For example, if you observe 2 Pods, but you return a desired list of 3 Pods,
you should return a Status that reflects only the observed Pods
(e.g. <code>replicas: 2</code>).
This is important so that Status reflects present reality, not future desires.</p>
<h4 id="working-with-status-subresource-in-metacontroller"><a class="header" href="#working-with-status-subresource-in-metacontroller">Working with Status subresource in metacontroller</a></h4>
<p>If you would like to expose and use the <code>Status</code> subresource in your custom resource, you should take care of:</p>
<ol>
<li>having a proper CRD schema definition for <code>Status</code> section in order to let metacontroller
update it successfully - it must be a part of CRD schema, i.e.</li>
</ol>
<pre><code class="language-yaml">---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: configmappropagations.examples.metacontroller.io
spec:
  ...
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            ...
          status:
            type: object
            properties:
              expected_copies:
                type: integer
              actual_copies:
                type: integer
              observedGeneration:
                type: integer
        required:
        - spec
    subresources:
      status: {}
</code></pre>
<ol start="2">
<li>your controller must be strict about the types in the schema defined in CRD, i.e., in example above
do not try to set any of the <code>integer</code> fields as <code>string</code>s, or add additional fields there.</li>
</ol>
<p>To read more about <code>Status</code> subresource please look at:</p>
<ul>
<li>Kubernetes documentation - https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#status-subresource</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../guide/create.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../guide/troubleshooting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../guide/create.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../guide/troubleshooting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
